<!-- music.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music | Sonus Concensus</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@0;1&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; background: #000; color: #fff; font-family: 'Inter', sans-serif; font-weight: 300; overflow-x: hidden; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; font-weight: normal; }
        
        /* Film Grain */
        .film-grain {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJhIiB4PSIwIiB5PSIwIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iLjc0IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMCIvPjwvZmlsdGVyPjxwYXRoIGQ9Ik0wIDBoMzAwdjMwMEgweiIgZmlsdGVyPSJ1cmwoI2EpIiBvcGFjaXR5PSIwLjAyIi8+PC9zdmc+');
            opacity: 0.02;
            pointer-events: none;
            z-index: 1;
            animation: grain 8s steps(10) infinite;
        }
        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-1%, -1%); }
            20% { transform: translate(1%, 2%); }
            30% { transform: translate(-2%, -1%); }
            40% { transform: translate(2%, 1%); }
            50% { transform: translate(-1%, 2%); }
            60% { transform: translate(1%, -1%); }
            70% { transform: translate(-2%, 1%); }
            80% { transform: translate(2%, -1%); }
            90% { transform: translate(-1%, -2%); }
        }
        
        /* Header */
        .page-header {
            padding: clamp(100px, 15vw, 150px) 5% 50px;
            text-align: center;
            position: relative;
        }
        .page-header h1 {
            font-size: clamp(3rem, 10vw, 6rem);
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }
        .page-header p {
            font-size: 1.2rem;
            color: #ccc;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Playlist */
        .playlist-container {
            padding: 0 5% 200px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .playlist-header {
            margin-bottom: 3rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #222;
        }
        .playlist-header h2 {
            font-size: 2rem;
            letter-spacing: 0.05em;
        }
        .tracks-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .track-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.4s ease;
            border-radius: 4px;
        }
        .track-card:hover {
            background: rgba(255,255,255,0.05);
        }
        .track-card.active {
            background: rgba(181, 159, 59, 0.1);
            box-shadow: 0 0 20px rgba(181, 159, 59, 0.1);
        }
        .track-cover {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #b59f3b 0%, #000 100%);
            margin-right: 1.5rem;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .track-info {
            flex: 1;
        }
        .track-info h4 {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }
        .track-info p {
            color: #aaa;
            font-size: 0.9rem;
        }
        .track-duration {
            color: #888;
            font-size: 0.9rem;
            margin-left: 1rem;
        }
        
        /* Audio Player */
        .audio-player {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #222;
            padding: 1rem 5%;
            z-index: 100;
        }
        .player-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        .player-cover {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #b59f3b 0%, #000 100%);
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .player-info {
            flex: 1;
            min-width: 0;
        }
        .player-info h4 {
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-info p {
            color: #aaa;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .progress-container {
            flex: 2;
            min-width: 0;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            cursor: pointer;
            margin-bottom: 0.5rem;
            border-radius: 2px;
        }
        .progress {
            width: 0%;
            height: 100%;
            background: #b59f3b;
            border-radius: 2px;
            transition: width 0.1s linear;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 0.8rem;
        }
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .control-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            transition: color 0.3s ease;
            font-size: 1.2rem;
        }
        .control-btn:hover {
            color: #b59f3b;
        }
        .play-pause {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: #b59f3b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 1.5rem;
        }
        .play-pause:hover {
            background: #c9b45c;
        }
        .volume-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .volume-slider {
            width: 80px;
            -webkit-appearance: none;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #b59f3b;
            cursor: pointer;
        }
        .shuffle-repeat {
            display: flex;
            gap: 0.5rem;
        }
        .shuffle-repeat button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        .shuffle-repeat button.active {
            color: #b59f3b;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 100px 5%;
        }
        .empty-state h3 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #b59f3b;
        }
        .empty-state p {
            color: #888;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Footer */
        footer {
            background: #111;
            padding: 3rem 5%;
            text-align: center;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }
        .footer-links {
            margin-bottom: 1.5rem;
        }
        .footer-links a {
            color: #fff;
            text-decoration: none;
            margin: 0 1rem;
            padding-bottom: 2px;
            position: relative;
        }
        .footer-links a::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            width: 0;
            height: 1px;
            background: #b59f3b;
            transition: width 0.4s ease;
        }
        .footer-links a:hover::after {
            width: 100%;
        }
        .copyright {
            color: #888;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }
        
        @media (max-width: 768px) {
            .audio-player {
                padding: 1rem;
            }
            .player-container {
                flex-direction: column;
                gap: 1rem;
            }
            .player-info, .progress-container, .player-controls {
                width: 100%;
            }
            .playlist-container {
                padding-bottom: 300px;
            }
            .control-btn {
                font-size: 1rem;
            }
            .play-pause {
                width: 45px; height: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- Film Grain Overlay -->
    <div class="film-grain"></div>

    <!-- Header -->
    <header class="page-header">
        <h1>Audio Library</h1>
        <p>Pure sonic landscapes. Each composition is a journey through carefully crafted frequencies designed for immersive listening.</p>
    </header>

    <!-- Playlist -->
    <div class="playlist-container">
        <!-- User: Paste full public Supabase Storage URL into 'audio_url' (and optional cover into 'cover_url') -->
        <div class="playlist-header">
            <h2>Current Collection</h2>
        </div>
        <div class="tracks-list" id="tracksList">
            <!-- Tracks will be loaded here -->
        </div>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" id="audioPlayer">
        <div class="player-container">
            <div class="player-cover" id="playerCover"></div>
            <div class="player-info">
                <h4 id="playerTitle">Select a track</h4>
                <p id="playerArtist">‚Äî</p>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            <div class="player-controls">
                <div class="shuffle-repeat">
                    <button id="shuffleBtn" title="Shuffle">‚ÜØ</button>
                    <button id="repeatBtn" title="Repeat">‚Üª</button>
                </div>
                <button class="control-btn" id="prevBtn" title="Previous">‚èÆ</button>
                <button class="control-btn play-pause" id="playBtn">‚ñ∂</button>
                <button class="control-btn" id="nextBtn" title="Next">‚è≠</button>
                <div class="volume-container">
                    <button class="control-btn" id="volumeBtn" title="Volume">üîä</button>
                    <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="index.html">Home</a>
            <a href="videos.html">Videos</a>
            <a href="music.html">Music</a>
        </div>
        <div class="copyright">¬© Sonus Concensus 2026‚Ñ¢</div>
    </footer>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://simlltekbhaljyuxpyrs.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpbWxsdGVrYmhhbGp5dXhweXJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTE4OTgsImV4cCI6MjA3NzE2Nzg5OH0.QowZXsw9nHjtIC-U1q_lJyc47Mi07mNYG8Skitq3QTQ';
        // Supabase client (renamed to avoid global shadow error)
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Audio Player State
        let player = {
            audio: new Audio(),
            tracks: [],
            currentTrackIndex: -1,
            isPlaying: false,
            isShuffle: false,
            repeatMode: 0, // 0: off, 1: one, 2: all
            volume: 0.8
        };
        
        // DOM Elements
        const tracksList = document.getElementById('tracksList');
        const audioPlayer = document.getElementById('audioPlayer');
        const playerCover = document.getElementById('playerCover');
        const playerTitle = document.getElementById('playerTitle');
        const playerArtist = document.getElementById('playerArtist');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTime = document.getElementById('currentTime');
        const duration = document.getElementById('duration');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeBtn = document.getElementById('volumeBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        
        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Load tracks
        async function loadSongs() {
            const { data: songs, error } = await supabaseClient
                .from('sonus_songs')
                .select('*')
                .order('created_at', { ascending: false });
                
            if (error) {
                console.error('Error loading library:', error);
                tracksList.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading library</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
                return;
            }
            
            if (!songs || songs.length === 0) {
                tracksList.innerHTML = `
                    <div class="empty-state">
                        <h3>Audio Library Growing</h3>
                        <p>Our sonic collection is currently being composed. New audio pieces will be available soon.</p>
                    </div>
                `;
                audioPlayer.style.display = 'none';
                return;
            }
            
            player.tracks = songs;
            
            // Render tracks
            tracksList.innerHTML = songs.map((song, index) => `
                <div class="track-card ${index === 0 ? 'active' : ''}" data-index="${index}">
                    <div class="track-cover" style="background-image: ${song.cover_url ? `url('${song.cover_url}')` : 'linear-gradient(135deg, #b59f3b 0%, #000 100%)'}"></div>
                    <div class="track-info">
                        <h4>${song.title}</h4>
                        <p>${song.artist || 'Sonus Concensus'} ‚Ä¢ ${song.album || 'Single'}</p>
                    </div>
                    <div class="track-duration">${formatTime(song.duration || 0)}</div>
                </div>
            `).join('');
            
            // Set first track as active
            if (songs.length > 0) {
                player.currentTrackIndex = 0;
                loadTrack(0);
            }
            
            // Add click events
            document.querySelectorAll('.track-card').forEach(card => {
                card.addEventListener('click', () => {
                    const index = parseInt(card.dataset.index);
                    playTrack(index);
                });
            });
        }
        
        // Load track
        function loadTrack(index) {
            if (index < 0 || index >= player.tracks.length) return;
            
            const track = player.tracks[index];
            player.audio.src = track.audio_url;
            player.audio.load();
            
            // Update UI
            playerCover.style.backgroundImage = track.cover_url ? 
                `url('${track.cover_url}')` : 
                'linear-gradient(135deg, #b59f3b 0%, #000 100%)';
            playerTitle.textContent = track.title;
            playerArtist.textContent = `${track.artist || 'Sonus Concensus'} ‚Ä¢ ${track.album || 'Single'}`;
            duration.textContent = formatTime(track.duration || 0);
            
            // Update active track
            document.querySelectorAll('.track-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.track-card[data-index="${index}"]`).classList.add('active');
        }
        
        // Play track
        function playTrack(index) {
            if (index === player.currentTrackIndex && player.isPlaying) {
                pauseAudio();
                return;
            }
            
            player.currentTrackIndex = index;
            loadTrack(index);
            playAudio();
        }
        
        // Play audio
        function playAudio() {
            player.audio.play();
            player.isPlaying = true;
            playBtn.innerHTML = '‚è∏';
        }
        
        // Pause audio
        function pauseAudio() {
            player.audio.pause();
            player.isPlaying = false;
            playBtn.innerHTML = '‚ñ∂';
        }
        
        // Next track
        function nextTrack() {
            let nextIndex;
            if (player.isShuffle) {
                nextIndex = Math.floor(Math.random() * player.tracks.length);
            } else {
                nextIndex = (player.currentTrackIndex + 1) % player.tracks.length;
            }
            playTrack(nextIndex);
        }
        
        // Previous track
        function prevTrack() {
            let prevIndex;
            if (player.audio.currentTime > 3) {
                // Restart current track if more than 3 seconds in
                player.audio.currentTime = 0;
                return;
            }
            
            if (player.isShuffle) {
                prevIndex = Math.floor(Math.random() * player.tracks.length);
            } else {
                prevIndex = player.currentTrackIndex - 1;
                if (prevIndex < 0) prevIndex = player.tracks.length - 1;
            }
            playTrack(prevIndex);
        }
        
        // Update progress
        function updateProgress() {
            const percent = (player.audio.currentTime / player.audio.duration) * 100 || 0;
            progress.style.width = `${percent}%`;
            currentTime.textContent = formatTime(player.audio.currentTime);
        }
        
        // Seek
        function seek(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const percent = clickX / width;
            player.audio.currentTime = percent * player.audio.duration;
        }
        
        // Update volume
        function updateVolume() {
            player.audio.volume = player.volume;
            volumeSlider.value = player.volume * 100;
        }
        
        // Toggle shuffle
        function toggleShuffle() {
            player.isShuffle = !player.isShuffle;
            shuffleBtn.classList.toggle('active', player.isShuffle);
        }
        
        // Toggle repeat
        function toggleRepeat() {
            player.repeatMode = (player.repeatMode + 1) % 3;
            repeatBtn.classList.remove('active');
            if (player.repeatMode === 1) {
                repeatBtn.classList.add('active');
                repeatBtn.title = 'Repeat One';
            } else if (player.repeatMode === 2) {
                repeatBtn.classList.add('active');
                repeatBtn.title = 'Repeat All';
            } else {
                repeatBtn.title = 'Repeat';
            }
        }
        
        // Event Listeners
        playBtn.addEventListener('click', () => {
            if (player.currentTrackIndex === -1 && player.tracks.length > 0) {
                playTrack(0);
            } else if (player.isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        });
        
        prevBtn.addEventListener('click', prevTrack);
        nextBtn.addEventListener('click', nextTrack);
        
        progressBar.addEventListener('click', seek);
        
        player.audio.addEventListener('timeupdate', updateProgress);
        player.audio.addEventListener('ended', () => {
            if (player.repeatMode === 1) {
                // Repeat one
                player.audio.currentTime = 0;
                player.audio.play();
            } else if (player.repeatMode === 2 || player.isShuffle) {
                // Repeat all or shuffle
                nextTrack();
            } else if (player.currentTrackIndex < player.tracks.length - 1) {
                // Next track if not last
                nextTrack();
            } else {
                // Stop at end
                pauseAudio();
                player.audio.currentTime = 0;
                updateProgress();
            }
        });
        
        volumeSlider.addEventListener('input', (e) => {
            player.volume = e.target.value / 100;
            updateVolume();
        });
        
        volumeBtn.addEventListener('click', () => {
            if (player.volume > 0) {
                player.volume = 0;
                volumeBtn.innerHTML = 'üîá';
            } else {
                player.volume = 0.8;
                volumeBtn.innerHTML = 'üîä';
            }
            updateVolume();
        });
        
        shuffleBtn.addEventListener('click', toggleShuffle);
        repeatBtn.addEventListener('click', toggleRepeat);
        
        // Initialize volume
        updateVolume();
        
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        // Load tracks on page load
        document.addEventListener('DOMContentLoaded', loadSongs);
    </script>
</body>
</html>
